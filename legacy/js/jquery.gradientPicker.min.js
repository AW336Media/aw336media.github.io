(function(n){function f(n,t){return n.position-t.position}function t(n,t){return typeof n.bind=="function"?n.bind(t):function(){n.apply(t,arguments)}}function e(i,r){var u,f,o,e,h;for(this.$el=i,this.$el.css("position","relative"),this.opts=r,u=n("<canvas class='gradientPicker-preview'><\/canvas>"),this.$el.append(u),f=u[0],f.width=200,f.height=1,this.g2d=f.getContext("2d"),o=n("<div class='gradientPicker-ctrlPts'><\/div>"),this.$el.append(o),this.$ctrlPtContainer=o,this.updatePreview=t(this.updatePreview,this),this.controlPoints=[],this.ctrlPtConfig=new s(this.$el,r),e=0;e<r.controlPoints.length;++e)h=this.createCtrlPt(r.controlPoints[e]),this.controlPoints.push(h);this.docClicked=t(this.docClicked,this);this.destroyed=t(this.destroyed,this);n(document).bind("click",this.docClicked);this.$el.bind("destroyed",this.destroyed);this.previewClicked=t(this.previewClicked,this);u.click(this.previewClicked);this.updatePreview()}function o(i,r,u,f,e){var o,s;this.$el=n("<div class='gradientPicker-ctrlPt'><\/div>");i.append(this.$el);this.$parentEl=i;this.configView=e;typeof r=="string"?(r=r.split(" "),this.position=parseFloat(r[1])/100,this.color=r[0]):(this.position=r.position,this.color=r.color);this.listener=f;this.outerWidth=this.$el.outerWidth();this.$el.css("background-color",this.color);u=="horizontal"?(o=(i.width()-this.$el.outerWidth())*this.position,this.$el.css("left",o),this.$el.css("position","absolute")):(s=(i.height()-this.$el.outerHeight())*this.position,this.$el.css("top",s));this.drag=t(this.drag,this);this.stop=t(this.stop,this);this.clicked=t(this.clicked,this);this.colorChanged=t(this.colorChanged,this);this.$el.draggable({axis:u=="horizontal"?"x":"y",drag:this.drag,stop:this.stop,containment:i});this.$el.click(this.clicked)}function s(i,r){var u,f;this.$el=n('<div class="gradientPicker-ptConfig" style="visibility: hidden"><\/div>');i.append(this.$el);u=n('<div id="cp_colorsel" style="height:5px;"> <\/div>');this.$el.append(u);f=n("<div class='gradientPicker-close'><\/div>");this.$el.append(f);this.colorChanged=t(this.colorChanged,this);this.closed=t(this.closed,this);this.removeClicked=t(this.removeClicked,this);u.colorpicker({select:this.colorChanged,colorFormat:"RGBA",parts:"popup",showOn:"button",buttonColorize:!0,buttonImage:"/legacy/img/select2.png",buttonColorize:!0,buttonImageOnly:!0,alpha:!0,close:this.closed});this.$cpicker=u;this.opts=r;this.visible=!1;f.click(this.removeClicked)}var u=new Image,i,r;n.event.special.destroyed||(n.event.special.destroyed={remove:function(n){n.handler&&n.handler()}});i="";n.browser.mozilla?i="-moz-":n.browser.webkit?i="-webkit-":n.browser.opera?i="-o-":n.browser.msie&&(i="-ms-");e.prototype={docClicked:function(){this.ctrlPtConfig.hide()},createCtrlPt:function(n){return new o(this.$ctrlPtContainer,n,this.opts.orientation,this,this.ctrlPtConfig)},destroyed:function(){n(document).unbind("click",this.docClicked)},updateOptions:function(t){var i,r;for(n.extend(this.opts,t),i=0;i<this.controlPoints.length;++i)this.controlPoints[i].$el.remove();for(this.controlPoints=[],i=0;i<t.controlPoints.length;++i)r=this.createCtrlPt(t.controlPoints[i]),this.controlPoints.push(r);this.updatePreview(!0)},updatePreview:function(n){var e=[],r,i,t,o,s;if(this.controlPoints.sort(f),this.opts.orientation=="horizontal")for(r=this.g2d.createLinearGradient(0,0,this.g2d.canvas.width,0),i=0;i<this.controlPoints.length;++i)t=this.controlPoints[i],r.addColorStop(t.position,t.color),e.push({position:t.position,color:t.color});this.g2d.clearRect(0,0,this.g2d.canvas.width,this.g2d.canvas.height);o=this.g2d.createPattern(u,"repeat");this.g2d.fillStyle=o;this.g2d.fillRect(0,0,this.g2d.canvas.width,this.g2d.canvas.height);this.g2d.fillStyle=r;this.g2d.fillRect(0,0,this.g2d.canvas.width,this.g2d.canvas.height);this.opts.generateStyles&&(s=this._generatePreviewStyles());n&&this.opts.change(e,s)},removeControlPoint:function(n){var t=this.controlPoints.indexOf(n);t!=-1&&(this.controlPoints.splice(t,1),n.$el.remove())},previewClicked:function(t){var r=n(t.target).offset(),u=t.pageX-r.left,s=t.pageY-r.top,i=this.g2d.getImageData(u,0,1,1),e="rgba("+i.data[0]+","+i.data[1]+","+i.data[2]+", 1)",o=this.createCtrlPt({position:u/this.g2d.canvas.width,color:e});this.controlPoints.push(o);this.controlPoints.sort(f)},_generatePreviewStyles:function(){for(var r,n=this.opts.type+"-gradient("+(this.opts.type=="linear"?this.opts.fillDirection+", ":""),u=!0,t=0;t<this.controlPoints.length;++t)r=this.controlPoints[t],u?u=!1:n+=", ",n+=r.color+" "+(r.position*100|0)+"%";return n=n+")",[n,i+n]}};o.prototype={drag:function(n,t){var i=t.position.left;this.position=i/(this.$parentEl.width()-this.outerWidth);this.listener.updatePreview(!1)},stop:function(){this.listener.updatePreview(!0);this.configView.show(this.$el.position(),this.color,this)},clicked:function(n){return this.configView.show(this.$el.position(),this.color,this),n.stopPropagation(),!1},colorChanged:function(n,t){this.color=n;this.$el.css("background-color",this.color);t&&this.listener.updatePreview(!0)},removeClicked:function(){this.listener.removeControlPoint(this);this.listener.updatePreview(!0)}};s.prototype={show:function(n,t,i){this.visible=!0;this.listener=i;this.$el.css("visibility","visible");this.$cpicker.colorpicker("setColor",t);this.opts.orientation==="horizontal"?this.$el.css("left",Math.min(n.left,i.$parentEl.width()-this.$el.outerWidth())):this.$el.css("top",n.top)},hide:function(){this.visible&&(this.$el.css("visibility","hidden"),this.visible=!1)},closed:function(n,t){this.listener.colorChanged(t.formatted,!0)},colorChanged:function(n,t){this.listener.colorChanged(t.formatted)},removeClicked:function(){this.listener.removeClicked();this.hide()}};r={init:function(t){t=n.extend({controlPoints:["#FFF 0%","#000 100%"],orientation:"horizontal",type:"linear",fillDirection:"left",generateStyles:!1,change:function(){}},t);u.src=src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAIAAAACUFjqAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAClJREFUeNpiPHPmDAMSMDY2RuYyMeAFNJVm/P//PzL/7Nmzg8VpAAEGALE5CHQT4Ca/AAAAAElFTkSuQmCC";this.each(function(){var i=n(this),r=new e(i,t);i.data("gradientPicker-sel",r)})},update:function(t){this.each(function(){var r=n(this),i=r.data("gradientPicker-sel");i!=null&&i.updateOptions(t)})}};n.fn.gradientPicker=function(n,t){typeof n=="string"&&n!=="init"?r[n].call(this,t):(t=n,r.init.call(this,t))}})(jQuery);