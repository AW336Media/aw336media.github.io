var CM={frameWidth:1920,frameHeight:1080,frameRate:23,ratio:1,aspect:1920/1080,currentFrame:1,totalFrames:161,enableRenderLoop:!0,enablePlayFrames:!1,timeelapsed:0,renderMode:!1,templates:[{image:"1.png",file:"1"},{image:"2.png",file:"2"},{image:"3.png",file:"3"}],scenes:{object:null,list2d:[{name:"Upload a Video",file:"video/video"},{name:"Upload an Image",file:"image/image"}],list3d:[{name:"Outdoor",file:"outdoor/outdoor"}]},objects:{objects:[],selected:-1},fx:{objects:[],selected:-1,list:[{name:"RGB Shift",file:"rgbshift"},{name:"Colorify",file:"colorify"},{name:"Film",file:"film"},{name:"Dot Screen",file:"dotscreen"},{name:"Antialiasing (FXAA)",file:"fxaa"},{name:"Fisheye",file:"fisheye"},{name:"Color Negative",file:"negative"}]},shaders:{materials:{}},appearance:{objects:{},list:{singlecolor:{name:"single color",index:0},texture:{name:"texture",index:1},pixelated:{name:"pixelated",index:2}},string:""},keyframes:{},timelineObjects:{scene:null,objects:null,fx:null,camera:null},maxDownloadSize:0,renderCancel:!1,fontList:["army rangers","bebas","blackout","cheri","chinese takeaway","corpulent caps brk","fightthis","magic school one","minercraftory","sf archery black"],tabActive:0},PZ={downloadBlob:null};CM.camProps={movementMode:0,rotationMode:1,keyframeProps:{position:[{frame:1,value:[0,0,80],tweenfn:null}],rotation:[{frame:1,value:[0,0,0],tweenfn:null}]},updateFrame:function(){var e=TWEEN.getValue(this.keyframeProps.position,CM.currentFrame);CM.renderCamera.position.set(e[0],e[1],e[2]),this.rotationMode?(e=TWEEN.getValue(this.keyframeProps.rotation,CM.currentFrame),CM.renderCamera.lookAt(new THREE.Vector3(e[0]*Math.PI/180,e[1]*Math.PI/180,e[2]*Math.PI/180))):(e=TWEEN.getValue(this.keyframeProps.rotation,CM.currentFrame),CM.renderCamera.rotation.set(e[0]*Math.PI/180,e[1]*Math.PI/180,e[2]*Math.PI/180))}},$(function(){$("#accordion").accordion({heightStyle:"fill",beforeActivate:function(e,t){switch(t.newHeader[0].textContent){case"Scene":CM.tabActive=2;break;case"Objects":CM.tabActive=3;break;case"FX":CM.tabActive=4;break;case"Camera Sequence":CM.tabActive=5;break;default:CM.tabActive=-1}CM.updateFrameUI()},animate:80}),$("#frameslider").slider({max:CM.totalFrames,min:1,step:1,slide:function(e,t){CM.currentFrame=t.value,CM.updateFrameUI(),CM.enablePlayFrames&&(CM.enablePlayFrames=!1)}}),$("#framecounter").text(Math.floor(CM.currentFrame)+"/"+CM.totalFrames),$("#fxList").sortable({distance:15,stop:function(e,t){var a=CM.fx.objects.splice(t.item.data("fxindex"),1)[0];CM.fx.objects.splice(t.item.index(),0,a),$("#fxList").find("li").each(function(e,t){CM.fx.selected==$(this).data("fxindex")&&(CM.fx.selected=e),$(this).data("fxindex",e)})}}),$("#renderprogress").progressbar(),$(window).resize(function(){clearTimeout(CM.resizeTimeout),CM.resizeTimeout=setTimeout(function(){$("#accordion").accordion("refresh"),CM.enableRenderLoop&&CM.resizeViewport()},500)}),CM.renderCanv=document.getElementById("c_main"),CM.fontSelector=$("#fontList").detach(),CM.setUpEditor(),CM.init()}),CM.setUpEditor=function(){var e,t=$("#templatelist");for(e=0;e<CM.templates.length;e++){var a=$("<a>",{"class":"tilebutton",href:"?t="+CM.templates[e].file}).append($("<span>").append($("<img>",{width:"225",height:"127",style:"border:0;padding:5px;",src:"/legacy/im/templates/"+CM.templates[e].image})));t.append(a)}CM.basics.select($("#basicsproperties")),CM.scenes.select($("#scene_page0")),CM.appearance.concatList(),PZeditor.generateTriInput({title:"Position",color:"hsl(0, 50%, 50%)",location:$("#camsequenceproperties"),keyframed:!0,tweens:!0,subtitle1:"X",subtitle2:"Y",subtitle3:"Z",property:CM.camProps.keyframeProps.position,vmax:1e4,vmin:-1e4,vstep:1}),PZeditor.generateSpacer({location:$("#camsequenceproperties")}),PZeditor.generateDropdown({location:$("#camsequenceproperties"),title:"Rotation mode",property:CM.camProps.rotationMode+1,updatefn:function(e){CM.camProps.rotationMode=e-1},items:"rotation;look at"}),PZeditor.generateTriInput({title:"Rotation",color:"hsl(0, 50%, 50%)",location:$("#camsequenceproperties"),keyframed:!0,tweens:!0,subtitle1:"X",subtitle2:"Y",subtitle3:"Z",property:CM.camProps.keyframeProps.rotation,vmax:1e4,vmin:-1e4,vstep:1})},CM.init=function(){if(!window.WebGLRenderingContext){var e=$("#previewpane");CM.renderCanv.height=e.height()-150,CM.renderCanv.width=e.width();var t=CM.renderCanv.getContext("2d"),a=CM.renderCanv.width/2,r=CM.renderCanv.height/2,n=.08*CM.renderCanv.height;return t.fillStyle="#000000",t.fillRect(0,0,2*a,2*r),t.textAlign="center",t.fillStyle="#ffffff",t.font=n.toString()+'px "Lucida Sans Unicode", "Lucida Grande", sans-serif',t.fillText("There was a problem starting WebGL.",a,r-n),t.font=(.6*n).toString()+'px "Lucida Sans Unicode", "Lucida Grande", sans-serif',void t.fillText("Refresh to try again or update your browser",a,r+n)}CM.renderer=new THREE.WebGLRenderer({alpha:!0,preserveDrawingBuffer:!0,canvas:CM.renderCanv}),CM.scene=new THREE.Scene,CM.camera=new THREE.PerspectiveCamera(60,CM.aspect,.1,1e3),CM.camera.position.set(50,30,50),CM.camera.lookAt(new THREE.Vector3(0,0,0)),CM.renderCamera=new THREE.PerspectiveCamera(60,CM.aspect,.1,1e3),CM.camHelper=new THREE.CameraHelper(CM.renderCamera),CM.scene.add(CM.camHelper),CM.hemiLight=new THREE.HemisphereLight(16777215,16777215,1),CM.scene.add(CM.hemiLight),CM.renderer.setClearColor(0,1),CM.renderer.shadowMapEnabled=!0,CM.renderer.shadowMapSoft=!0,CM.renderer.shadowMapType=THREE.PCFSoftShadowMap,CM.renderer.shadowCameraNear=3,CM.renderer.shadowCameraFar=800,CM.composer=new THREE.EffectComposer(CM.renderer),CM.composer.setSize(CM.renderCanv.width,CM.renderCanv.height),CM.composer.renderPass=new THREE.RenderPass(CM.scene,CM.renderCamera),CM.composer.copyPass=new THREE.ShaderPass(CM.shaders.load("copy",{tDiffuse:{type:"t",value:null},opacity:{type:"f",value:1}}),"tDiffuse"),CM.composer.copyPass.renderToScreen=!0,$(CM.renderCanv).css("position","relative"),CM.resizeViewport(),CM.controls=new THREE.EditorControls(CM.camera,CM.renderer.domElement),CM.gridHelper=new THREE.GridHelper(100,10),CM.gridHelper.setColors(new THREE.Color(13421772),new THREE.Color(3355443)),CM.gridHelper.position.set(0,0,0),CM.scene.add(CM.gridHelper);var o=CM.getParameterByName("t");o&&$.ajax({cache:!0,dataType:"text",url:"/legacy/im/templates/"+o+".txt",success:function(e){CM.loadTemplate(e)}}),requestAnimationFrame(CM.render)},CM.shaders.load=function(e,t,a,r,n){return void 0===n&&(n="/legacy/im/fragment/"+e+".js"),CM.shaders.materials[e]?CM.shaders.materials[e].ref+=1:$.ajax({url:n,dataType:"text",async:!1,cache:!1,success:function(n){CM.shaders.materials[e]={},CM.shaders.materials[e].shader=new THREE.ShaderMaterial({uniforms:THREE.UniformsUtils.clone(t),vertexShader:$("#vertexShader").text(),fragmentShader:n,transparent:a?!0:!1,lights:r?!0:!1}),CM.shaders.materials[e].ref=1}}),CM.shaders.materials[e].shader.clone()},CM.shaders.unload=function(e){CM.shaders.materials[e].ref-=1,CM.shaders.materials[e].ref<=0&&(CM.shaders.materials[e].shader.dispose(),delete CM.shaders.materials[e])},CM.appearance.load=function(e){CM.appearance.objects[e]||$.ajax({url:"/legacy/im/appearance/"+e+".js",dataType:"text",cache:!1,async:!1,success:function(t){CM.appearance.objects[e]=new Function(t)()}});var t=CM.appearance.objects[e];return t.refcount+=1,CM.shaders.load(t.shaderid,t.uniforms,!0,!0)},CM.appearance.unload=function(e){CM.appearance.objects[e]&&(CM.shaders.unload(CM.appearance.objects[e].shaderid),CM.appearance.objects[e].refcount-=1,CM.appearance.objects[e].refcount<=0&&(CM.appearance.objects[e]=null,delete CM.appearance.objects[e]))},CM.appearance.concatList=function(){var e=!1;for(prop in CM.appearance.list)e&&(CM.appearance.string+=";"),CM.appearance.string+=CM.appearance.list[prop].name,e=!0},CM.render=function(e,t){CM.enableRenderLoop&&(CM.enablePlayFrames&&(0==CM.timeelapsed&&(CM.timeelapsed=e),CM.currentFrame+=(e-CM.timeelapsed)/(1e3/CM.frameRate),CM.timeelapsed=e,CM.currentFrame>CM.totalFrames&&(CM.currentFrame=1),CM.updateFrameUI(!0)),requestAnimationFrame(CM.render)),CM.updateScene(t),CM.scene.updateMatrixWorld(),CM.renderMode||t?CM.composer.render():CM.renderer.render(CM.scene,CM.camera)},CM.updateScene=function(e){CM.sceneObject&&CM.sceneObject.update();for(var t=0;t<CM.objects.objects.length;t++)CM.objects.objects[t].updateFrame();if(CM.camProps.updateFrame(),CM.renderMode||e)for(t=0;t<CM.fx.objects.length;t++)CM.fx.objects[t].update();else CM.renderCamera.updateMatrixWorld()},CM.resizeViewport=function(e,t){void 0===e?(($("#previewpane").height()-150-61-28)*CM.aspect>$("#previewpane").width()?(CM.renderCanv.width=$("#previewpane").width(),CM.renderCanv.height=CM.renderCanv.width/CM.aspect):(CM.renderCanv.height=$("#previewpane").height()-150-61-28,CM.renderCanv.width=CM.renderCanv.height*CM.aspect),$(CM.renderCanv).css("top",.5*($("#previewpane").height()-150-61-28-CM.renderCanv.height)),$(CM.renderCanv).css("left",.5*($("#previewpane").width()-CM.renderCanv.width)),CM.ratio=CM.renderCanv.width/CM.frameWidth):(CM.renderCanv.width=e,CM.renderCanv.height=t),CM.renderer.setViewport(0,0,CM.renderCanv.width,CM.renderCanv.height),CM.composer.setSize(CM.renderCanv.width,CM.renderCanv.height);var a;for(a=0;a<CM.fx.objects.length;a++)CM.fx.objects[a].resize();CM.sceneObject&&CM.sceneObject.resize()},CM.rebuildShaders=function(){for(var e=0;e<objectsProps.length;e++)objectsProps[e].type<3&&null!==objectsProps[e].threeObj&&(objectsProps[e].threeObj.material.needsUpdate=!0)},CM.updateMaterials=function(){CM.scene.traverse(function(e){if(e.material&&(e.material.needsUpdate=!0,e.material instanceof THREE.MeshFaceMaterial))for(var t=0;t<e.material.materials.length;t++)e.material.materials[t].needsUpdate=!0})},CM.scenes.change=function(e,t){$("#scenepages").children().hide();var a=$("#sceneproperties");a.empty(),CM.sceneObject&&(CM.sceneObject.unload(),CM.sceneObject=null),e?$.ajax({url:"/legacy/im/scene/"+e+".js",dataType:"text",cache:!1,success:function(e){CM.sceneObject=new Function(e)(),CM.sceneObject.load(t),CM.sceneObject.select(a),$("#scene_page1").show()}}):$("#scene_page0").show()},CM.scenes.select=function(e){PZeditor.generateTitle({location:e,title:"2D"});for(var t=0;t<CM.scenes.list2d.length;t++)PZeditor.generateButton({location:e,title:CM.scenes.list2d[t].name,clickfn:function(){CM.scenes.change($(this).data().file)}}).data({file:CM.scenes.list2d[t].file});PZeditor.generateTitle({location:e,title:"3D"});for(var t=0;t<CM.scenes.list3d.length;t++)PZeditor.generateButton({location:e,title:CM.scenes.list3d[t].name,clickfn:function(){CM.scenes.change($(this).data().file)}}).data({file:CM.scenes.list3d[t].file})},CM.objects.add=function(e,t){switch(e){case 0:CM.objects.objects.push(CM.objects.add3dshape());break;case 1:CM.objects.objects.push(CM.objects.add3dtext());break;case 2:CM.objects.objects.push(CM.objects.add3dmodel());break;case 3:CM.objects.objects.push(CM.objects.addlight())}CM.objects.objects[CM.objects.objects.length-1].load(t),CM.objects.addListItem()},CM.objects.addListItem=function(){var e=$("<li>").append("Object "+CM.objects.objects.length).click(function(){$(this).toggleClass("selected").siblings().removeClass("selected");var e=-1;$("#objectList > .selected").each(function(){e=$(this).index()}),CM.objects.select(e)});e.append($("<img>",{title:"delete","class":"delimg",src:"/legacy/img/delete.png"}).click(function(){CM.objects["delete"]($(this).parent().index()),$(this).parent().remove()})),$("#objectList").append(e)},CM.objects["delete"]=function(e){CM.objects.objects[e].unload(),CM.objects.selected==e&&CM.objects.select(-1),CM.objects.objects.splice(e,1)},CM.objects.select=function(e){var t=$("#objectsproperties");return t.empty(),CM.objects.selected=e,-1==e?(CM.keysObjects=null,$("#objectList").children().removeClass("selected"),void CM.updateFrameUI()):void CM.objects.objects[e].select(t)},CM.fx.add=function(e,t){e&&$.ajax({url:"/legacy/im/fx/"+e+".js",dataType:"text",cache:!1,success:function(e){CM.fx.objects.push(new Function(e)()),CM.fx.objects[CM.fx.objects.length-1].load(t),CM.fx.addListItem()}})},CM.fx.addListItem=function(){var e=$("<li>").data("fxindex",CM.fx.objects.length-1).append(CM.fx.objects[CM.fx.objects.length-1].name).click(function(){$(this).toggleClass("selected").siblings().removeClass("selected");var e;$("#fxList > .selected").each(function(){e=this}),CM.fx.select(e)});e.append($("<img>",{title:"delete","class":"delimg",src:"/legacy/img/delete.png"}).click(function(){CM.fx["delete"](this)})),$("#fxList").append(e)},CM.fx["delete"]=function(e){var t=$(e).parent().data("fxindex");$(e).parent().remove(),CM.fx.objects[t].unload(),CM.fx.objects.splice(t,1),$("#fxList").find("li").each(function(e,t){$(this).data("fxindex",e)}),CM.fx.selected==t&&CM.fx.select(null)},CM.fx.select=function(e){var t=$("#postproperties");if(t.children().remove(),!e)return CM.fx.selected=-1,CM.keysFX=null,$("#fxList").children().removeClass("selected"),void CM.updateFrameUI();var a=parseInt($(e).data("fxindex"));CM.fx.selected=a,CM.fx.objects[a].select(t)},CM.keyframes.exists=function(e,t){for(var a=0;a<e.length;a++)if(e[a].frame==Math.floor(t))return e[a];return null},CM.keyframes["delete"]=function(e,t){if(1!=t){for(var a=0;a<e.length;a++)e[a].frame==Math.floor(t)&&e.splice(a,1);CM.updateFrameUI()}},CM.keyframes.add=function(e,t){for(var a=Math.floor(t),r=TWEEN.getValue(e,a),n={frame:a,value:Array.isArray(r)?r.slice():r,tweenfn:0},o=0;o<e.length;o++)if(e[o].frame>a)return e.splice(o,0,n),void CM.updateFrameUI();e.push(n),CM.updateFrameUI()},CM.keyframes.next=function(e,t){for(var a=Math.floor(t),r=0,n=e.length-1;n>-1&&e[n].frame>a;n--)r=e[n].frame;return 0==r?t:r},CM.keyframes.previous=function(e,t){for(var a=Math.floor(t),r=0,n=0;n<e.length&&e[n].frame<a;n++)r=e[n].frame;return 0==r?t:r},CM.keyframes.moveForward=function(e,t){var a=Math.floor(t);if(a!=CM.totalFrames){for(var r=0;r<e.length;r++)if(e[r].frame==a)return e[r+1]&&e[r+1].frame==a+1?a:(e[r].frame=a+1,a+1);return t}},CM.keyframes.moveBackward=function(e,t){var a=Math.floor(t);if(1!=a){for(var r=0;r<e.length;r++)if(e[r].frame==a)return e[r-1]&&e[r-1].frame==a-1?a:(e[r].frame=a-1,a-1);return t}},CM.updateFrameUI=function(e){if($("#framecounter").text(Math.floor(CM.currentFrame)+"/"+CM.totalFrames),$("#timecounter").text(((CM.currentFrame-1)/CM.frameRate).toFixed(2)),$("#frameslider").slider("option","value",Math.floor(CM.currentFrame)),!e){var t,a=function(){$(this).data("updateKeyframe")&&$(this).data("updateKeyframe")()};switch(CM.tabActive){case 2:$("#sceneproperties > [keyframe='true']").each(a),t=CM.timelineObjects.scene;break;case 3:$("#objectsproperties > [keyframe='true']").each(a),t=CM.timelineObjects.objects;break;case 4:$("#postproperties > [keyframe='true']").each(a),t=CM.timelineObjects.fx;break;case 5:$("#camsequenceproperties > [keyframe='true']").each(a),t=CM.camProps.keyframeProps}if(CM.sliderCanv||(CM.sliderCanv=document.createElement("canvas"),$("#frameslider").append($(CM.sliderCanv))),CM.sliderCanv.width=$("#frameslider").innerWidth(),CM.sliderCanv.height=$("#frameslider").innerHeight(),t){var r,n,o=0,s=0;for(n in t)o++;for(n in t){r=255-15*(s%2),CM.sliderCanv.getContext("2d").fillStyle="rgb("+r+", "+r+", "+r+")",CM.sliderCanv.getContext("2d").fillRect(0,s*(CM.sliderCanv.height/o),CM.sliderCanv.width,CM.sliderCanv.height/o),CM.sliderCanv.getContext("2d").fillStyle="hsl("+s*(360/o)+", 50%, 50%)";for(var i=0;i<t[n].length;i++)CM.sliderCanv.getContext("2d").fillRect($("#frameslider").innerWidth()*(t[n][i].frame-1)/(CM.totalFrames-1)-CM.sliderCanv.width/CM.totalFrames*.5,s*(CM.sliderCanv.height/o),CM.sliderCanv.width/CM.totalFrames,CM.sliderCanv.height/o);s++}}else CM.sliderCanv.getContext("2d").fillStyle="white",CM.sliderCanv.getContext("2d").fillRect(0,0,CM.sliderCanv.width,CM.sliderCanv.height)}},CM.toggleFrameRun=function(){CM.enablePlayFrames?(CM.enablePlayFrames=!1,CM.updateFrameUI()):(CM.timeelapsed=0,CM.enablePlayFrames=!0,CM.updateFrameUI())},CM.setRenderMode=function(e){e?(CM.renderer.autoClear=!1,CM.controls.enabled=!1,CM.camHelper.visible=!1,CM.gridHelper.visible=!1):(CM.renderer.autoClear=!0,CM.controls.enabled=!0,CM.gridHelper.visible=!0,CM.camHelper.visible=!0)},CM.toggleRenderMode=function(){CM.renderMode=!CM.renderMode,$("#a_renderMode").css("background-color",CM.renderMode?"#B91616":"#333333"),CM.setRenderMode(CM.renderMode)},CM.loadFont=function(e,t){var a;for(var r in _typeface_js.faces){if(a=!1,!_typeface_js.faces.hasOwnProperty(r))return;for(var n=0;n<CM.objects.objects.length;n++)if(CM.objects.objects[n]&&CM.objects.objects[n].normalProps&&CM.objects.objects[n].normalProps.font==r){a=!0;break}a||delete _typeface_js.faces[r]}$.ajax({cache:!0,dataType:"script",url:"/legacy/im/preset_fonts/"+e+".js",success:t})},CM.finishRender=function(){$("#mask").hide(),$("#renderdialog").hide(),CM.currentFrame=1,$("#previewpane").append(CM.renderCanv),CM.resizeViewport(),CM.builder=null,PZ.downloadBlob=null,CM.setRenderMode(CM.renderMode),CM.enableRenderLoop=!0,CM.enablePlayFrames=!1,requestAnimationFrame(CM.render)},CM.renderVideo=function(){CM.enableRenderLoop=!1,CM.builder=new movbuilder.MotionJPEGBuilder,CM.builder.setup(CM.frameWidth,CM.frameHeight,CM.frameRate),$("#renderdialog").css("top",Math.max(0,($(window).height()-$("#renderdialog").outerHeight())/2+$(window).scrollTop())+"px").css("left",Math.max(0,($(window).width()-$("#renderdialog").outerWidth())/2+$(window).scrollLeft())+"px"),$("#renderprogress").progressbar("option","value",0),$("#rendertitle").text("Rendering video..."),$("#cancelrender").show(),$("#downloaddialog").hide(),$("#closedialog").hide(),$("#mask").show(),$("#renderdialog").show(),CM.currentFrame=1,CM.updateFrameUI(),CM.setRenderMode(!0),$(CM.renderCanv).detach(),CM.resizeViewport(CM.frameWidth,CM.frameHeight),CM.sceneObject&&"video/video"==CM.sceneObject.file?CM.sceneObject.update(!0,function(){setTimeout(CM.renderVideoFrame,0)}):setTimeout(CM.renderVideoFrame,0)},CM.renderVideoFrame=function(){if($("#renderprogress").progressbar("option","value",CM.currentFrame/CM.totalFrames*85),CM.renderCancel)return void CM.finishRender();var e;CM.render(null,!0),e=CM.builder.addCanvasFrame(CM.renderer.domElement,.8),CM.currentFrame++,CM.currentFrame<=CM.totalFrames?e>=CM.maxDownloadSize&&CM.maxDownloadSize>0||(CM.sceneObject&&"video/video"==CM.sceneObject.file?CM.sceneObject.update(!0,function(){setTimeout(CM.renderVideoFrame,0)}):setTimeout(CM.renderVideoFrame,0)):($("#rendertitle").text("Generating video..."),setTimeout(function(){CM.builder.finish(function(e){$("#renderprogress").progressbar("option","value",100),$("#rendertitle").text("Finished."),$("#cancelrender").hide(),$("#downloaddialog").show(),$("#closedialog").show(),CM.builder=null,PZ.downloadBlob=e})},0))},CM.getBase64Image=function(e){if(!e)return null;var t=document.createElement("canvas");t.width=e.width,t.height=e.height;var a=t.getContext("2d");a.drawImage(e,0,0);var r=t.toDataURL("image/png");return r.replace(/^data:image\/(png|jpg);base64,/,"")},CM.saveTemplate=function(){var e,t={};for(t.totalFrames=CM.totalFrames,t.objects=[],e=0;e<CM.objects.objects.length;e++)t.objects.push(CM.objects.objects[e].save());for(t.camProps=$.extend({},{keyframeProps:CM.camProps.keyframeProps,rotationMode:CM.camProps.rotationMode}),t.fx=[],e=0;e<CM.fx.objects.length;e++)t.fx.push(CM.fx.objects[e].save());return CM.sceneObject&&(t.sceneObject=CM.sceneObject.save()),JSON.stringify(t)},CM.loadTemplate=function(e){var t,a=JSON.parse(e);for(CM.objects.select(-1),CM.fx.select(null),CM.totalFrames=a.totalFrames,$("#frameslider").slider("option","max",CM.totalFrames),$("#basicsproperties_2 input").val(Math.floor(CM.totalFrames/CM.frameRate)).attr("aria-valuenow",Math.floor(CM.totalFrames/CM.frameRate)),CM.updateFrameUI(),t=0;t<a.objects.length;t++)CM.objects.add(a.objects[t].type,a.objects[t]);for($.extend(!0,CM.camProps,a.camProps),t=0;t<a.fx.length;t++)CM.fx.add(a.fx[t].file,a.fx[t]);a.sceneObject&&CM.scenes.change(a.sceneObject.file,a.sceneObject)},CM.getParameterByName=function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)"),a=t.exec(location.search);return null==a?"":decodeURIComponent(a[1].replace(/\+/g," "))},CM.generateRandomColor=function(e){for(var t=[],a=0;3>a;a++)t[a]=Math.floor(255*Math.random());return e&&(t[3]=255),t},CM.getBytecolor=function(e){m=/^rgba?\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)$/.exec(e);var t=[];if(m){for(var a=0;3>a;a++)t[a]=Number(m[a+1]);m[4]&&(t[3]=Number(255*m[4]))}return t},CM.getHexcolor=function(e){return e[0]<<16^e[1]<<8^e[2]<<0},THREE.EditorControls=function(e,t){function a(e){c.enabled!==!1&&(e.preventDefault(),0===e.button?C=l.ROTATE:1===e.button?C=l.ZOOM:2===e.button&&(C=l.PAN),f.set(e.clientX,e.clientY),t.addEventListener("mousemove",r,!1),t.addEventListener("mouseup",n,!1),t.addEventListener("mouseout",n,!1),t.addEventListener("dblclick",n,!1))}function r(e){if(c.enabled!==!1){e.preventDefault(),m.set(e.clientX,e.clientY);var t=m.x-f.x,a=m.y-f.y;C===l.ROTATE?c.rotate(new THREE.Vector3(.005*-t,.005*-a,0)):C===l.ZOOM?c.zoom(new THREE.Vector3(0,0,a)):C===l.PAN&&c.pan(new THREE.Vector3(-t,a,0)),f.set(e.clientX,e.clientY)}}function n(e){t.removeEventListener("mousemove",r,!1),t.removeEventListener("mouseup",n,!1),t.removeEventListener("mouseout",n,!1),t.removeEventListener("dblclick",n,!1),C=l.NONE}function o(e){var t=0;e.wheelDelta?t=-e.wheelDelta:e.detail&&(t=10*e.detail),c.zoom(new THREE.Vector3(0,0,t))}function s(e){if(c.enabled!==!1){switch(e.touches.length){case 1:h[0].set(e.touches[0].pageX,e.touches[0].pageY,0),h[1].set(e.touches[0].pageX,e.touches[0].pageY,0);break;case 2:h[0].set(e.touches[0].pageX,e.touches[0].pageY,0),h[1].set(e.touches[1].pageX,e.touches[1].pageY,0),v=h[0].distanceTo(h[1])}b[0].copy(h[0]),b[1].copy(h[1])}}function i(e){if(c.enabled!==!1){e.preventDefault(),e.stopPropagation();var t=function(e,t){var a=t[0];for(var r in t)a.distanceTo(e)>t[r].distanceTo(e)&&(a=t[r]);return a};switch(e.touches.length){case 1:h[0].set(e.touches[0].pageX,e.touches[0].pageY,0),h[1].set(e.touches[0].pageX,e.touches[0].pageY,0),c.rotate(h[0].sub(t(h[0],b)).multiplyScalar(-.005));break;case 2:h[0].set(e.touches[0].pageX,e.touches[0].pageY,0),h[1].set(e.touches[1].pageX,e.touches[1].pageY,0),distance=h[0].distanceTo(h[1]),c.zoom(new THREE.Vector3(0,0,v-distance)),v=distance;var a=h[0].clone().sub(t(h[0],b)),r=h[1].clone().sub(t(h[1],b));a.x=-a.x,r.x=-r.x,c.pan(a.add(r).multiplyScalar(.5))}b[0].copy(h[0]),b[1].copy(h[1])}}t=void 0!==t?t:document,this.enabled=!0,this.center=new THREE.Vector3;var c=this,d=new THREE.Vector3,l={NONE:-1,ROTATE:0,ZOOM:1,PAN:2},C=l.NONE,M=this.center,p=new THREE.Matrix3,m=new THREE.Vector2,f=new THREE.Vector2,u={type:"change"};this.focus=function(t,a){var r=new THREE.Vector3;if(t.matrixWorld.decompose(M,new THREE.Quaternion,r),a&&t.geometry){r=(r.x+r.y+r.z)/3,M.add(t.geometry.boundingSphere.center.clone().multiplyScalar(r));var n=t.geometry.boundingSphere.radius*r,o=e.position.clone().sub(M).normalize().multiplyScalar(2*n);e.position.copy(M).add(o)}e.lookAt(M),c.dispatchEvent(u)},this.pan=function(t){p.getNormalMatrix(e.matrix),t.applyMatrix3(p),t.multiplyScalar(.001*d.copy(M).sub(e.position).length()),e.position.add(t),M.add(t),c.dispatchEvent(u)},this.zoom=function(t){p.getNormalMatrix(e.matrix),t.applyMatrix3(p),t.multiplyScalar(.001*d.copy(M).sub(e.position).length()),e.position.add(t),c.dispatchEvent(u)},this.rotate=function(t){d.copy(e.position).sub(M);var a=Math.atan2(d.x,d.z),r=Math.atan2(Math.sqrt(d.x*d.x+d.z*d.z),d.y);a+=t.x,r+=t.y;var n=1e-6;r=Math.max(n,Math.min(Math.PI-n,r));var o=d.length();d.x=o*Math.sin(r)*Math.sin(a),d.y=o*Math.cos(r),d.z=o*Math.sin(r)*Math.cos(a),e.position.copy(M).add(d),e.lookAt(M),c.dispatchEvent(u)},t.addEventListener("contextmenu",function(e){e.preventDefault()},!1),t.addEventListener("mousedown",a,!1),t.addEventListener("mousewheel",o,!1),t.addEventListener("DOMMouseScroll",o,!1);var h=(new THREE.Vector3,[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3]),b=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],v=null;t.addEventListener("touchstart",s,!1),t.addEventListener("touchmove",i,!1)},THREE.EditorControls.prototype=Object.create(THREE.EventDispatcher.prototype);