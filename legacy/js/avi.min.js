(function(n){"use strict";function t(){this.b64=new r;this.movieDesc={w:0,h:0,fps:0,videoStreamSize:0,maxJPEGSize:0};this.avi=t.createAVIStruct();this.headerLIST=t.createHeaderLIST();this.moviLIST=t.createMoviLIST();this.frameList=[]}var f=16,e=16,u=1e6,i,r;t.prototype={setup:function(n,t,i){this.movieDesc.w=n;this.movieDesc.h=t;this.movieDesc.fps=i},addCanvasFrame:function(n,t){var e=n.toDataURL("image/jpeg",t),o=e.indexOf(",")+1,i=this.b64.decode(e.substring(o)),u,r,f;for(i.length%2&&i.push(0),u=new Uint8Array(i.length),r=0;r<i.length;r++)u[r]=i[r];return f=u.byteLength,this.movieDesc.videoStreamSize+=f,this.frameList.push(u),this.movieDesc.maxJPEGSize<f&&(this.movieDesc.maxJPEGSize=f),this.movieDesc.videoStreamSize},addVideoStreamData:function(n,i){var r=t.createMoviStream();return r.dwSize=i.byteLength,r.handler=function(){return i},n.push(r),r.dwSize+8},finish:function(n){var w=0,c,l,y,f,r,o,s,i,a,p,h;this.moviLIST.aStreams=[];var k=this.frameList.length,v=[],b=4,d=["chId","dwFlags","dwOffset","dwLength"];for(c=0;c<k;c++)l=this.addVideoStreamData(this.moviLIST.aStreams,this.frameList[c]),v.push({chId:"00dc",dwFlags:e,dwOffset:b,dwLength:l-8,_order:d}),b+=l,w+=l;this.moviLIST.dwSize=w+4;y=Math.floor(u/this.movieDesc.fps);f=t.createStreamHeader();f.wRight=this.movieDesc.w;f.wBottom=this.movieDesc.h;f.dwLength=this.frameList.length;f.dwScale=y;r=t.createBitmapHeader();r.dwWidth=this.movieDesc.w;r.dwHeight=this.movieDesc.h;r.dwSizeImage=3*r.dwWidth*r.dwHeight;o=t.createStreamFormat();o.dwSize=r.dwSize;o.sContent=r;s=t.createStreamHeaderLIST();s.dwSize=4+(f.dwSize+8)+(o.dwSize+8);s.aList=[f,o];i=t.createAVIMainHeader();i.dwMicroSecPerFrame=y;i.dwMaxBytesPerSec=this.movieDesc.maxJPEGSize*this.movieDesc.fps;i.dwTotalFrames=this.frameList.length;i.dwWidth=this.movieDesc.w;i.dwHeight=this.movieDesc.h;i.dwSuggestedBufferSize=0;a=4;a+=i.dwSize+8;a+=s.dwSize+8;this.headerLIST.dwSize=a;this.headerLIST.aData=[i,s];p={chFourCC:"idx1",dwSize:v.length*16,aData:v,_order:["chFourCC","dwSize","aData"]};h=0;h+=8+this.headerLIST.dwSize;h+=8+this.moviLIST.dwSize;h+=8+p.dwSize;this.avi.dwSize=h+4;this.avi.aData=[this.headerLIST,this.moviLIST,p];this.build(n)},build:function(n){i=[];t.appendStruct(this.avi);var r=new Blob(i,{type:"video/avi"});i=null;n(r)}};i=[];t.appendStruct=function(n,r){var l,y,h,o,u,a,p,v,s,f,e,w,c;if(r=r||0,!n._order)throw"Structured data must have '_order'";for(l=n._order,y=l.length,h=0;h<y;h++){o=l[h];u=n[o];!1&&console.log("          ".substring(0,r)+o);switch(o.charAt(0)){case"b":a=new ArrayBuffer(1);p=new Uint8Array(a);p[0]=a;i.push(u);break;case"c":i.push(u);break;case"d":v=new ArrayBuffer(4);s=new Uint8Array(v);s[0]=u&255;s[1]=u>>8&255;s[2]=u>>16&255;s[3]=u>>24&255;i.push(v);break;case"w":f=new ArrayBuffer(2);e=new Uint8Array(f);e[0]=u&255;e[1]=u>>8&255;i.push(f);break;case"W":f=new ArrayBuffer(2);e=new Uint8Array(f);e[0]=u>>8&255;e[1]=u&255;i.push(f);break;case"a":for(w=u.length,c=0;c<w;c++)t.appendStruct(u[c],r+1);break;case"r":i.push(u);break;case"s":t.appendStruct(u,r+1);break;case"h":i.push(u());break;default:throw"Unknown data type: "+o;}}};t.createAVIStruct=function(){return{chRIFF:"RIFF",chFourCC:"AVI ",dwSize:0,aData:null,_order:["chRIFF","dwSize","chFourCC","aData"]}};t.createAVIMainHeader=function(){return{chFourCC:"avih",dwSize:56,dwMicroSecPerFrame:66666,dwMaxBytesPerSec:1e3,dwPaddingGranularity:0,dwFlags:f,dwTotalFrames:1,dwInitialFrames:0,dwStreams:1,dwSuggestedBufferSize:0,dwWidth:10,dwHeight:20,dwReserved1:0,dwReserved2:0,dwReserved3:0,dwReserved4:0,_order:["chFourCC","dwSize","dwMicroSecPerFrame","dwMaxBytesPerSec","dwPaddingGranularity","dwFlags","dwTotalFrames","dwInitialFrames","dwStreams","dwSuggestedBufferSize","dwWidth","dwHeight","dwReserved1","dwReserved2","dwReserved3","dwReserved4"]}};t.createHeaderLIST=function(){return{chLIST:"LIST",dwSize:0,chFourCC:"hdrl",aData:null,_order:["chLIST","dwSize","chFourCC","aData"]}};t.createMoviLIST=function(){return{chLIST:"LIST",dwSize:0,chFourCC:"movi",aStreams:null,_order:["chLIST","dwSize","chFourCC","aStreams"]}};t.createMoviStream=function(){return{chType:"00dc",dwSize:0,handler:null,_order:["chType","dwSize","handler"]}};t.createStreamHeaderLIST=function(){return{chLIST:"LIST",dwSize:0,chFourCC:"strl",aList:null,_order:["chLIST","dwSize","chFourCC","aList"]}};t.createStreamFormat=function(){return{chFourCC:"strf",dwSize:0,sContent:null,_order:["chFourCC","dwSize","sContent"]}};t.createStreamHeader=function(){return{chFourCC:"strh",dwSize:56,chTypeFourCC:"vids",chHandlerFourCC:"mjpg",dwFlags:0,wPriority:0,wLanguage:0,dwInitialFrames:0,dwScale:66666,dwRate:u,dwStart:0,dwLength:0,dwSuggestedBufferSize:0,dwQuality:1e4,dwSampleSize:0,wLeft:0,wTop:0,wRight:0,wBottom:0,_order:["chFourCC","dwSize","chTypeFourCC","chHandlerFourCC","dwFlags","wPriority","wLanguage","dwInitialFrames","dwScale","dwRate","dwStart","dwLength","dwSuggestedBufferSize","dwQuality","dwSampleSize","wLeft","wTop","wRight","wBottom"]}};t.createBitmapHeader=function(){return{dwSize:40,dwWidth:10,dwHeight:20,wPlanes:1,wBitcount:24,chCompression:"MJPG",dwSizeImage:600,dwXPelsPerMeter:0,dwYPelsPerMeter:0,dwClrUsed:0,dwClrImportant:0,_order:["dwSize","dwWidth","dwHeight","wPlanes","wBitcount","chCompression","dwSizeImage","dwXPelsPerMeter","dwYPelsPerMeter","dwClrUsed","dwClrImportant"]}};t.createMJPEG=function(){return{W_SOI:65496,aSegments:null,W_EOI:65497,_order:["dwSOI","aSegments","dwEOI"]}};t.KnownMarkers={192:"SOF0",196:"DHT",218:"SOS",219:"DQT",221:"DRI",224:"APP0"};r=function(){this.initialize()};r.prototype.initialize=function(){var t,n;for(this.symbols=[],t="A".charCodeAt(0),n=0;n<26;n++)this.symbols.push(String.fromCharCode(t+n));for(t="a".charCodeAt(0),n=0;n<26;n++)this.symbols.push(String.fromCharCode(t+n));for(t="0".charCodeAt(0),n=0;n<10;n++)this.symbols.push(String.fromCharCode(t+n));for(this.symbols.push("+","/"),this.encodeMap=[],n=0;n<this.symbols.length;n++)this.encodeMap[n]=this.symbols[n];for(this.decodeMap=[],n=0;n<this.symbols.length;n++)this.decodeMap[this.symbols[n]]=n;this.decodeMap["="]=null};r.prototype.decode=function(n){var i,r,t,f,s,h;if(n.length%4!=0)throw"encoded.length must be a multiple of 4.";for(i=[],r=this.decodeMap,t=0,f=n.length;t<f;t+=4){var c=r[n[t]],e=r[n[t+1]],u=r[n[t+2]],o=r[n[t+3]],l=(c<<2)+(e>>4)&255;if(i.push(l),u==null)break;if(s=(e<<4)+(u>>2)&255,i.push(s),o==null)break;h=(u<<6)+o&255;i.push(h)}return i};n.movbuilder={MotionJPEGBuilder:t}})(window);
/*
//# sourceMappingURL=avi.min.js.map
*/